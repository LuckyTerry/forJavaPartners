# 项目中的技术选型

1. 讲一下项目背景？

项目是做智慧门店系统，致力于为客户提供一站式的解决方案，主要的业态是智慧餐饮，在最近也涉足了智慧零售这个业态。
分了几个平台，我主要负责xxx部分。

2. Hystrix为什么没有使用默认的线程池，而是采用了信号量

- 当时是基于两方面考虑的：
- 第一，项目初期有服务的TPS要求，在对信号量隔离和线程池隔离充分压测的情况下，我们发现信号量性能领先于线程池很多
- 第二，项目中存在着Threadlocal传递的上下文，使用线程池时无法获取到上下文，因此选择信号量
- 那现在回过头来看的话，存在着挺多问题：
- 第一，信号量隔离粒度大，无法对服务或接口进行资源隔离，无法防止服务雪崩
- 第二，ThreadLocal上下文可以通过自定义HystrixConcurrencyStrategy实现类来完成传递
- 第三，服务性能也通过各种优化提升上来了，现在更应该考虑的是可用性，而不是这一点性能

3. Redis的数据结构在项目中怎么使用的

- string 用的最多
- hash 在订单的优惠中有使用
    - 订单的优惠是存在多种类型，在这里field是优惠类型，value是该类型对应的优惠金额，可以独立的修改或获取某些类型的优惠金额
- list 
    - todo
- set
    - todo
- sorted 在订单的挂单业务中有使用
     - 进行到一半的订单因为客人有事情（比如接电话去了），那么就将讲该订单挂起，然后处理下一个客人的订单。
     - 那么就会把“订单详情”用string存储，“订单id”使用sorted set存储，其中“订单创建时间作为score”
     - 每次读取的时候，根据score清除过期的订单，然后返回有效订单id，再去string中查询订单详情，最后返回有效订单列表。
     
4. 项目中Redis的使用的是何种内存淘汰策略，为什么？

- 使用的是 allkeys-lru
- 缓存中也有比较经常访问的数据，满足一个二八原则，所以最好采用lru算法
- 另外，在 大量key 未设置过期时间的情况下，volatile会退化成 noeviction，所以采用allkeys-lru，折中，一般也不会出问题

5. 对于item的扣库存能使用redis来操作以提升性能吗

- 使用redis的 watch, multi, exec 实现 CAS的扣减库存即可 [Redis CAS乐观锁实现](https://www.jianshu.com/p/08a1a9f2f4dd)

6. 如何对已分库的各种表重新分库分表呢

- 主动migrate，根据ID循环查询db中的数据，数据写入sharding程序
- 被动migrate，订阅binlog，数据写入sharding程序
- 参考 [不停机分库分表迁移](https://www.jianshu.com/p/223d71421f49)

7. 项目核心接口的TPS是多少？峰值的瓶颈在哪？

- 现在是要求500TPS，压测两天，要求集群中不能有服务、中间件宕机。
- 瓶颈在大部分服务副本数只有2个，能处理请求的线程有限，导致有很多长尾请求，拉低了整体TPS。
- 外部平台的同步请求响应慢，拉低TPS。
- 压测仅仅是对一个商户进行的压测，数据都落到了一个库，所以并不能体现系统整体的TPS。这块儿测试未给我们具体的值，我们也不太好优化。

8. 如果要求提升到5000，你要怎么设计？

- 架构上
    - tps增大10倍，可以认为商户数量也增大10倍。
    - 现在是根据商户做了分库，所以数据库瓶颈跟以前一样。
    - 服务这块儿可以增加副本实例完成请求分流。
    - 缓存可以部署成集群，进一步应对高并发。
    - ribbon负载均衡效率没能达到1+1=2的效率，需要进一步研究。
- 细节上
    - 网关的切面逻辑中涉及到的功能需要进行优化和压测。
    - 更多的缓存使用
    - 更多的异步使用
